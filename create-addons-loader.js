const fs = require('fs');
const path = require('path');
const cryptoRandomString = require('crypto-random-string');

const titleCase = (w) => w.slice(0, 1).toUpperCase() + w.slice(1, w.length);

/*
 * Transforms a package name to javascript variable name
 */
function nameFromPackage(name) {
  if (
    name.startsWith('~') ||
    name.startsWith('.') ||
    name.startsWith(path.sep)
  ) {
    name =
      name.replace('~', '').split('.').join('').split(path.sep).join('') ||
      cryptoRandomString({ length: 10, characters: 'abcdefghijk' });
  }
  return name
    .split('-')
    .map((w, i) => (i > 0 ? titleCase(w) : w))
    .join('');
}

/*
 * Creates a static file with code necessary to load the addons configuration
 *
 */
function getAddonsLoaderCode(addons = []) {
  let buf = `/* This file is autogenerated. Don't change it directly.
Instead, change the "addons" setting in your package.json file.
`;
  let configsToLoad = [];

  addons.forEach((addonConfigString) => {
    let extras;
    const addonConfigLoadInfo = addonConfigString.split(':');
    const pkgName = addonConfigLoadInfo[0];
    const defaultImport = nameFromPackage(pkgName);
    if (addonConfigLoadInfo.length > 1) {
      extras = addonConfigLoadInfo[1].split(',');
    }
    const line = `import ${defaultImport}${
      extras ? `, { ${extras.join(', ')} }` : ''
    } from '${pkgName}';\n
    console.log('${defaultImport}', ${defaultImport});
    `;
    buf += line;
    configsToLoad = [...configsToLoad, defaultImport, ...(extras || [])];
  });

  buf += `
const load = (config) => {
  const addonLoaders = [${configsToLoad.join(', ')}];
  // return addonLoaders.reduce((acc, apply) => apply(acc), config)
  return config;
};
export default load;
`;

  return buf;
}

module.exports = (addons) => {
  const addonsLoaderPath = path.join(
    process.cwd(),
    'src',
    'load-volto-addons.js',
  );
  const code = getAddonsLoaderCode(addons);
  fs.writeFileSync(addonsLoaderPath, new Buffer.from(code));
  return addonsLoaderPath;
};

module.exports.getAddonsLoaderCode = getAddonsLoaderCode;
module.exports.nameFromPackage = nameFromPackage;
