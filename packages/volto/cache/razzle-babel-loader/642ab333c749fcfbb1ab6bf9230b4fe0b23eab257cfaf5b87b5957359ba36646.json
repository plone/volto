{"ast":null,"code":"var _module;\n/**\n * AuthToken helper.\n * @module helpers/AuthToken\n */\n\nimport Cookies from 'universal-cookie';\nimport jwtDecode from 'jwt-decode';\nimport { loginRenew } from '@plone/volto/actions/userSession/userSession';\nimport { getCookieOptions } from '@plone/volto/helpers/Cookies/cookies';\nimport { push } from 'connected-react-router';\n\n/**\n * Get auth token method (does not work in SSR)\n * @method getAuthToken\n * @returns {undefined}\n */\nexport function getAuthToken() {\n  const cookies = new Cookies();\n  return cookies.get('auth_token');\n}\n\n/**\n * Persist auth token method.\n * @method persistAuthToken\n * @param {object} store Redux store.\n * @returns {undefined}\n */\nexport function persistAuthToken(store, req) {\n  const cookies = new Cookies();\n  let currentValue;\n  if (req) {\n    // We are in SSR\n    currentValue = req.universalCookies.get('auth_token');\n  } else {\n    currentValue = cookies.get('auth_token');\n  }\n\n  /**\n   * handleChange method.\n   * @method handleChange\n   * @param {bool} initial Initial call.\n   * @returns {undefined}\n   */\n  function handleChange(initial) {\n    const previousValue = currentValue;\n    const state = store.getState();\n    currentValue = state.userSession.token;\n    if (module.hot && module.hot.data && module.hot.data.reloaded && previousValue) {\n      currentValue = previousValue;\n    }\n    if (previousValue !== currentValue || initial) {\n      if (!currentValue) {\n        if (previousValue) {\n          cookies.remove('auth_token', {\n            path: '/'\n          });\n        }\n      } else {\n        if (previousValue !== currentValue) {\n          cookies.set('auth_token', currentValue, getCookieOptions({\n            expires: new Date(jwtDecode(currentValue).exp * 1000)\n          }));\n        }\n        const exp = (jwtDecode(store.getState().userSession.token).exp * 1000 - new Date().getTime()) * 0.9 || 3600000;\n        setTimeout(() => {\n          if (store.getState().userSession.token) {\n            if (jwtDecode(store.getState().userSession.token).exp * 1000 > new Date().getTime()) {\n              store.dispatch(loginRenew());\n            } else {\n              // Logout\n              store.dispatch(push(`/logout?return_url=${store.getState().router.location.pathname}`));\n            }\n          }\n        }, exp);\n      }\n    }\n  }\n  store.subscribe(handleChange);\n  handleChange(true);\n}\nif ((_module = module) !== null && _module !== void 0 && _module.hot) {\n  module.hot.dispose(data => {\n    data.reloaded = true;\n  });\n}","map":{"version":3,"names":["Cookies","jwtDecode","loginRenew","getCookieOptions","push","getAuthToken","cookies","get","persistAuthToken","store","req","currentValue","universalCookies","handleChange","initial","previousValue","state","getState","userSession","token","module","hot","data","reloaded","remove","path","set","expires","Date","exp","getTime","setTimeout","dispatch","router","location","pathname","subscribe","_module","dispose"],"sources":["/Users/varshanmaji/Projects/volto/packages/volto/src/helpers/AuthToken/AuthToken.js"],"sourcesContent":["/**\n * AuthToken helper.\n * @module helpers/AuthToken\n */\n\nimport Cookies from 'universal-cookie';\nimport jwtDecode from 'jwt-decode';\n\nimport { loginRenew } from '@plone/volto/actions/userSession/userSession';\nimport { getCookieOptions } from '@plone/volto/helpers/Cookies/cookies';\nimport { push } from 'connected-react-router';\n\n/**\n * Get auth token method (does not work in SSR)\n * @method getAuthToken\n * @returns {undefined}\n */\nexport function getAuthToken() {\n  const cookies = new Cookies();\n  return cookies.get('auth_token');\n}\n\n/**\n * Persist auth token method.\n * @method persistAuthToken\n * @param {object} store Redux store.\n * @returns {undefined}\n */\nexport function persistAuthToken(store, req) {\n  const cookies = new Cookies();\n  let currentValue;\n  if (req) {\n    // We are in SSR\n    currentValue = req.universalCookies.get('auth_token');\n  } else {\n    currentValue = cookies.get('auth_token');\n  }\n\n  /**\n   * handleChange method.\n   * @method handleChange\n   * @param {bool} initial Initial call.\n   * @returns {undefined}\n   */\n  function handleChange(initial) {\n    const previousValue = currentValue;\n    const state = store.getState();\n    currentValue = state.userSession.token;\n\n    if (\n      module.hot &&\n      module.hot.data &&\n      module.hot.data.reloaded &&\n      previousValue\n    ) {\n      currentValue = previousValue;\n    }\n\n    if (previousValue !== currentValue || initial) {\n      if (!currentValue) {\n        if (previousValue) {\n          cookies.remove('auth_token', { path: '/' });\n        }\n      } else {\n        if (previousValue !== currentValue) {\n          cookies.set(\n            'auth_token',\n            currentValue,\n            getCookieOptions({\n              expires: new Date(jwtDecode(currentValue).exp * 1000),\n            }),\n          );\n        }\n        const exp =\n          (jwtDecode(store.getState().userSession.token).exp * 1000 -\n            new Date().getTime()) *\n            0.9 || 3600000;\n        setTimeout(() => {\n          if (store.getState().userSession.token) {\n            if (\n              jwtDecode(store.getState().userSession.token).exp * 1000 >\n              new Date().getTime()\n            ) {\n              store.dispatch(loginRenew());\n            } else {\n              // Logout\n              store.dispatch(\n                push(\n                  `/logout?return_url=${\n                    store.getState().router.location.pathname\n                  }`,\n                ),\n              );\n            }\n          }\n        }, exp);\n      }\n    }\n  }\n\n  store.subscribe(handleChange);\n  handleChange(true);\n}\n\nif (module?.hot) {\n  module.hot.dispose((data) => {\n    data.reloaded = true;\n  });\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{"react-intl":{"messages":[]}},"sourceType":"module","externalDependencies":[]}